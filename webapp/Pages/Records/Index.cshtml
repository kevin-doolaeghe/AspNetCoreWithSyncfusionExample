@page "{handler?}"
@model webapp.Pages.Records.IndexModel
@{
    ViewData["PageTitle"] = "Records";

    var toolbarItems = new string[] {
        "Add", "Edit", "Delete", "Print", "ExcelExport", "PdfExport", "Search"
    };

    var statusItems = new object[] {
        new { Value = false, Text = "Pending" },
        new { Value = true, Text = "Closed" }
    };
    var statusDropDownList = new Syncfusion.EJ2.DropDowns.DropDownList() {
        DataSource = statusItems,
        Query = "new ej.data.Query()",
        Fields = new Syncfusion.EJ2.DropDowns.DropDownListFieldSettings() { Value = "Value", Text = "Text" },
        AllowFiltering = true,
        FilterType = Syncfusion.EJ2.DropDowns.FilterType.Contains,
    };

    var categoryItems = new string[] { "💰 Salary", "🍔 Food", "🎁 Pleasure", "⚽ Activity", "💸 Savings" };
    var categoryDropDownList = new Syncfusion.EJ2.DropDowns.DropDownList() {
        DataSource = categoryItems,
        Query = "new ej.data.Query()",
        AllowFiltering = true,
        FilterType = Syncfusion.EJ2.DropDowns.FilterType.Contains
    };
}
@Html.AntiForgeryToken()

<ejs-grid id="grid" load="onLoad" dataBound="dataBound" actionComplete="actionComplete" allowPaging="true" allowSorting="true" allowFiltering="true" allowPdfExport="true" allowExcelExport="true" pdfExportComplete="pdfExportComplete" excelExportComplete="excelExportComplete" toolbarClick="toolbarClick" toolbar="toolbarItems" autoFit="true">
    <e-data-manager url="Records/DataSource" crudUrl="Records/CrudUpdate" adaptor="UrlAdaptor"></e-data-manager>
    <e-grid-editSettings allowAdding="true" allowDeleting="true" allowEditing="true" mode="Dialog" showConfirmDialog="true" showDeleteConfirmDialog="true"></e-grid-editSettings>
    <e-grid-filtersettings type="Menu"></e-grid-filtersettings>
    <e-grid-searchSettings fields="@(new string[] { "Note", "Category", "Status" })" operator="contains" ignoreCase="true"></e-grid-searchSettings>
    <e-grid-loadingIndicator indicatorType="Shimmer"></e-grid-loadingIndicator>
    <e-grid-pagesettings pageSize="20"></e-grid-pagesettings>
    <e-grid-columns>
        <e-grid-column field="recordId" headerText="Id" isPrimaryKey="true" visible="false"></e-grid-column>
        <e-grid-column field="date" headerText="Date" format="dd/MM/yyyy" editType="datepickeredit" validationRules="@(new { required = true })"></e-grid-column>
        <e-grid-column field="isDone" headerText="Status" template="#statusTemplate" type="boolean" editType="dropdownedit" edit="new { @params = statusDropDownList }" validationRules="@(new { required = true })"></e-grid-column>
        <e-grid-column field="note" headerText="Note" validationRules="@(new { required = true })"></e-grid-column>
        <e-grid-column field="category" headerText="Category" editType="dropdownedit" type="string" edit="new { @params = categoryDropDownList }" validationRules="@(new { required = true })"></e-grid-column>
        <e-grid-column field="amount" headerText="Amount" template="#amountTemplate" editType="numericedit" format="C2" validationRules="@(new { required = true })"></e-grid-column>
    </e-grid-columns>
</ejs-grid>

<script id="statusTemplate" type="text/x-template">
    ${if(isDone)}
        <span class="badge bg-success p-2">${status}</span>
    ${else}
        <span class="badge bg-danger p-2">${status}</span>
    ${/if}
</script>

<script id="amountTemplate" type="text/x-template">
    ${if(amount > 0)}
        <span class="badge bg-success p-2">${formattedAmount}</span>
    ${else}
        <span class="badge bg-danger p-2">${formattedAmount}</span>
    ${/if}
</script>

<script>
    function onLoad() {
        this.dataSource.dataSource.headers = [{ "XSRF-TOKEN": $("input:hidden[name='__RequestVerificationToken']").val() }];
    }

    function dataBound(args) {
        this.autoFitColumns();
    }

    function actionComplete(args) {
        if ((args.requestType === "beginEdit" || args.requestType === "add")) {
            var dialog = args.dialog;
            dialog.element.style.maxHeight = "1000px";
        }
    }

    function toolbarClick(args) {
        var gridObj = document.getElementById("grid").ej2_instances[0];
        if (args.item.id === "Grid_pdfexport") {
            gridObj.showSpinner();
            gridObj.pdfExport();
        }
        if (args.item.id === "Grid_excelexport") {
            gridObj.showSpinner();
            gridObj.excelExport();
        }
    }

    function pdfExportComplete(args) {
        this.hideSpinner();
    }

    function excelExportComplete(args) {
        this.hideSpinner();
    }
</script>
